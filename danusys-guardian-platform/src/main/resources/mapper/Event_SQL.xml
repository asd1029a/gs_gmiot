<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="event">
	<select id="selectEventList" parameterType="map" resultType="com.danusys.guardian.common.util.EgovMap">
		SELECT a.* FROM (
			SELECT
				ROW_NUMBER() OVER(ORDER BY a.EVT_OCR_YMD_HMS DESC) AS "rnum",
				coalesce(b.EVT_NM,' ') AS "evtNm",
				coalesce(a.EVT_PLACE,' ') AS "evtPlace",
				TO_CHAR(TO_TIMESTAMP(a.EVT_OCR_YMD_HMS,'YYYYMMDDHH24MISS'),'YYYY.MM.DD HH24:MI:SS') AS "evtOcrYmdHms",
				coalesce(TO_CHAR(TO_TIMESTAMP(a.EVT_END_YMD_HMS,'YYYYMMDDHH24MISS'),'YYYY.MM.DD HH24:MI:SS'), '0001.01.01 00:00:00') AS "evtEndYmdHms",
				a.EVT_OCR_NO AS "evtOcrNo",
				coalesce(a.EVT_ID,' ')  AS "evtId",
				CASE WHEN a.EVT_ID IN ('112UC001','119UC001','SAFETY') THEN a.EVT_ID
					ELSE 'ETC' END AS "evtGbn",
				coalesce(a.EVT_GRAD_CD,' ') AS "evtGrad",
				coalesce(a.RCEPT_USER_NM,' ') AS "receptUserNm",
				CASE a.EVT_GRAD_CD
					WHEN '10' THEN '긴급'
					WHEN '20' THEN '일반'
				END AS "evtGradKr",
				CASE a.EVT_PRGRS_CD 
					WHEN '10' THEN '발생(신규)'
					WHEN '20' THEN '접수(승인)'
					WHEN '25' THEN '수동발생'
					WHEN '30' THEN '접수(승인)/수동발생'
					WHEN '90' THEN '취소'
					WHEN '91' THEN '완료(종료)'
					WHEN '92' THEN '완료(자동종료)'
					WHEN '35' THEN '수동종료'
					WHEN '93' THEN '이관'
				END AS "evtPrgrsCdKr",
				a.EVT_PRGRS_CD as "evtPrgrsCd",
				coalesce(a.RCEPT_CONTS, ' ') as "rceptConts",
				coalesce(a.RCEPT_USER_ID, ' ') as "rceptUserId",
				coalesce(a.EVT_DTL,' ') AS "evtDtl",
				a.LONGITUDE::text as "lon",
				a.LATITUDE::text as "lat",
				a.POINT_Z AS "pointZ",
				a.IMG_URL AS "imgUrl",
				coalesce(b.ICON_URL,' ') AS "iconUrl",
				b.MNGR_USER_ID AS "mngrUserId",
				a.AREA_CD AS "evtSpace",
				(SELECT COALESCE(SPLIT_PART(STRING_AGG(DISTINCT m.name,',' ORDER BY m.name ASC),',',1) || ' 외 ' || COUNT(m.name)-1,'') FROM ADMIN m 
					, CM_EVENT_MNGR_USER u 
				 	WHERE 1=1
				 	AND u.EVT_ID = a.EVT_ID
				 	AND u.USER_ID = m.ID
				) AS "evtMngrUser"
			FROM CM_EVT_OCR a 
			JOIN CM_EVENT b ON a.EVT_ID = b.EVT_ID
			JOIN CM_EVENT_GROUP_DETAIL c ON b.EVT_ID = c.EVT_ID
			JOIN ADMIN d ON c.GROUP_ID = d.EVENT_GROUP_ID
			WHERE 1=1
			<if test="mapBound != null and mapBound != ''">
			AND ST_WITHIN(ST_GEOMFROMTEXT('POINT('||a.LONGITUDE||' '||a.LATITUDE||')'),ST_GEOMFROMTEXT('POLYGON(('||#{mapBound}||'))')) = true
			</if>
			<if test="userId != null and userId != ''">
				AND d.ID = #{userId}
			</if>
			<if test="evtOcrNo != null and evtOcrNo != ''">
				AND a.EVT_OCR_NO = #{evtOcrNo}
			</if>
			<if test="pageKind == 'eventM'">
				AND a.EVT_PRGRS_CD IN('10','15','20','25','30')
			</if>
			<if test="pageKind == 'eventS'">
				AND a.EVT_PRGRS_CD IN('10','15')
			</if>
			<if test="pageKind == 'eventP'">
				AND a.EVT_PRGRS_CD IN('20','30','25')
			</if>
			<if test="pageKind == 'eventE'">
				AND a.EVT_PRGRS_CD IN('91','92','35')
			</if>
			<if test="pageKind == 'eventL'">
				AND a.EVT_PRGRS_CD IN('10','15','20','25','30','91','92','35')
			</if>
			<if test="evtId != null and evtId != ''"><![CDATA[
			AND a.EVT_ID = #{evtId}
			]]></if>
			<if test="evtPrgrsCd != null and evtPrgrsCd != ''"><![CDATA[
			AND a.EVT_PRGRS_CD = #{evtPrgrsCd}
			]]></if>
			<if test="eventDeS != null and eventDeS != ''"><![CDATA[
			AND #{eventDeS} <= TO_CHAR(TO_TIMESTAMP(a.EVT_OCR_YMD_HMS,'YYYYMMDDHH24MISS'),'YYYY-MM-DD')
			]]></if>
			<if test="eventDeE != null and eventDeE != ''"><![CDATA[
			AND #{eventDeE} >= TO_CHAR(TO_TIMESTAMP(a.EVT_OCR_YMD_HMS,'YYYYMMDDHH24MISS'),'YYYY-MM-DD')
			]]></if>
			<if test="eventFlag == 'end'"><![CDATA[
			AND a.EVT_END_YMD_HMS IS NOT NULL
			]]></if>
			<choose>
	            <when test="evtSpace != null">
					<foreach collection="evtSpace" item="item" index="index" separator="," open="AND a.AREA_CD IN (" close=")">
					#{item}
					</foreach>
				</when>
	        </choose>
			<choose>
	 			<when test="evtEtcCk != null and evtEtcCk != ''">
					<if test="eventEtc != null and eventEtc != ''">
		 				AND a.EVT_ID !~ #{eventEtc}					
					</if>
	 			</when>
	 			<otherwise>
					<if test="evtIds != null and evtIds != ''">
		 				AND a.EVT_ID ~ #{evtIds}
					</if>
		 		</otherwise>
			</choose>
			<choose>
	 			<when test="evtSpace2 != null and evtSpace2 != ''">
		 			AND a.AREA_CD ~ #{evtSpace2}
	 			</when>
			</choose>
			<if test="evtDtl != null and evtDtl != ''">
				AND a.EVT_DTL ~ #{evtDtl}
			</if>
		) a
		WHERE 1=1
		<if test="evtOcrNo != null and evtOcrNo != ''"><![CDATA[
		AND "evtOcrNo" = #{evtOcrNo}
		]]></if>
		<if test="evtStat != null and evtStat != ''"><![CDATA[
		AND "evtFlag" = #{evtStat}
		]]></if>
		<if test="evtId != null and evtId != ''"><![CDATA[
		AND "evtId" = #{evtId}
		]]></if>
		<if test="totSearch != null and totSearch != ''">
			
		</if>
		<if test='recordCountPerPage != -1'><![CDATA[
      	AND "rnum" <= #{lastIndex}
      	AND "rnum" > #{firstIndex}
      	]]></if>
      	ORDER BY "rnum"
	</select>
	
	<select id="selectEventCarList" parameterType="map" resultType="com.danusys.guardian.common.util.EgovMap">
		SELECT ('['||STRING_AGG(lonlat,',' ORDER BY t.evtDate)||']') AS lonlat
		FROM (
			SELECT  '['||a.LONGITUDE||','||a.LATITUDE||']' AS lonlat, SUBSTR(a.EVT_OCR_YMD_HMS, 1, 8) AS dateGbn, EVT_DTL AS evtDtl, a.EVT_OCR_YMD_HMS AS evtDate
			FROM CM_EVT_OCR a
			JOIN CM_EVENT b ON a.EVT_ID = b.EVT_ID
			JOIN CM_EVENT_GROUP_DETAIL c ON b.EVT_ID = c.EVT_ID
			JOIN ADMIN d ON c.GROUP_ID = d.EVENT_GROUP_ID
			WHERE 1=1
			AND a.EVT_ID = 'LPRUM101'
			<if test="userId != null and userId != ''">
				AND d.ID = #{userId}
			</if>
			<if test="pageKind == 'eventM'">
				AND a.EVT_PRGRS_CD IN ('10','30')
			</if>
			<if test="pageKind == 'eventE'">
				AND a.EVT_PRGRS_CD IN('91','92','35')
			</if>
			<if test="evtDtl != null and evtDtl != ''">
				AND a.EVT_DTL LIKE '%'||#{evtDtl}||'%'
			</if>
			<if test="evtTime != null and evtTime != ''">
				AND SUBSTR(a.EVT_OCR_YMD_HMS,1,8) = REPLACE(#{evtTime},'.','')
			</if>
			AND a.LONGITUDE != 0
		) t
		WHERE 1=1
		GROUP BY evtDtl,  dateGbn
	</select>
	
	<update id="saveEvent" parameterType="map">
		 INSERT INTO CM_EVT_OCR
		 (
	 		EVT_OCR_NO,
			EVT_ID,
			EVT_DTL,
			EVT_OCR_YMD_HMS,
			EVT_END_YMD_HMS,
			EVT_PRGRS_CD,
			RCEPT_USER_ID,
			RCEPT_CONTS,
			EVT_GRAD_CD,
			EVT_PLACE,
			LONGITUDE,
			LATITUDE,
			AREA_CD
	 	)
	 	VALUES(
	 		#{evtOcrNo},
			#{evtId},
			#{evtDtl},
			#{evtOcrYmdHms},
			#{evtEndYmdHms},
			#{evtPrgrsCd},
			#{rceptUserId},
			#{rceptConts},
			#{evtGrad},
			#{evtPlace},
			CAST(#{lon} AS DOUBLE PRECISION),
			CAST(#{lat} AS DOUBLE PRECISION),
			#{areaCd}
	 	) 
	 	ON CONFLICT
	 	(EVT_OCR_NO)
	 	DO UPDATE SET
	 		EVT_DTL = #{evtDtl},
			EVT_END_YMD_HMS = #{evtEndYmdHms},
			RCEPT_USER_ID = #{rceptUserId},
			RCEPT_CONTS = #{rceptConts},
			EVT_PRGRS_CD = #{evtPrgrsCd},
			EVT_PLACE = #{evtPlace},
			LONGITUDE = CAST(#{lon} AS DOUBLE PRECISION),
			LATITUDE = CAST(#{lat} AS DOUBLE PRECISION),
			UPD_USER_ID = #{rceptUserId},
			UPD_DATE = NOW()
	</update>
	
	<insert id="insertEvent" parameterType="map">
		INSERT INTO CM_EVT_OCR(
			EVT_OCR_NO,
			EVT_ID,
			EVT_DTL,
			EVT_OCR_YMD_HMS,
			EVT_PRGRS_CD,
			EVT_GRAD_CD,
			EVT_PLACE,
			LONGITUDE,
			LATITUDE,
			AREA_CD
		)
		VALUES(
			#{evtOcrNo},
			#{evtId},
			#{evtDtl},
			#{evtOcrYmdHms},
			'30',
			#{evtGrad},
			#{evtPlace},
			CAST(#{lon} AS DOUBLE PRECISION),
			CAST(#{lat} AS DOUBLE PRECISION),
			#{areaCd}
		)
		
	</insert>
	
	<select id="eventInfo" parameterType="map" resultType="HashMap">
			SELECT 
				ROW_NUMBER() OVER(ORDER BY a.EVT_OCR_YMD_HMS DESC) AS "rnum",
				a.EVT_OCR_NO AS "evtOcrNo",
				a.EVT_ID AS "evtId",
				a.EVT_GRAD_CD AS "evtGrad",
				CASE a.EVT_PRGRS_CD 
					WHEN '10' THEN '발생(신규)'
					WHEN '15' THEN '수동발생'
					WHEN '20' THEN '접수(승인)'
					WHEN '25' THEN '수동처리중'
					WHEN '30' THEN '접수(승인)/수동발생'
					WHEN '90' THEN '취소'
					WHEN '91' THEN '완료(종료)'
					WHEN '92' THEN '완료(자동종료)'
					WHEN '35' THEN '수동종료'
					WHEN '93' THEN '이관'
				END AS "evtPrgrsCdKr",
				a.EVT_PRGRS_CD as "evtPrgrsCd",
				a.EVT_PLACE AS "evtPlace",
				a.EVT_DTL AS "evtDtl",
				TO_CHAR(TO_TIMESTAMP(a.EVT_OCR_YMD_HMS,'YYYYMMDDHH24MISS'),'YYYY/MM/DD HH24:MI:SS') AS "evtOcrYmdHms",
				TO_CHAR(TO_TIMESTAMP(a.EVT_END_YMD_HMS,'YYYYMMDDHH24MISS'),'YYYY/MM/DD HH24:MI:SS') AS "evtEndYmdHms",
				a.LONGITUDE::text as "lon",
				a.LATITUDE::text as "lat",
				a.POINT_Z AS "pointZ",
				b.EVT_NM AS "evtNm",
				COALESCE(b.ICON_URL,' ') AS "iconUrl",
				b.VMS_START_CODE AS "vmsStartCd",
				b.VMS_END_CODE AS "vmsEndCd"
			FROM CM_EVT_OCR a 
			JOIN CM_EVENT b ON a.EVT_ID = b.EVT_ID
			WHERE 1=1
			AND a.EVT_OCR_NO = #{evtOcrNo}
	</select>
	
	<select id="selectOneHourAgoList" parameterType="map" resultType="HashMap">
		SELECT
			a.EVT_OCR_NO AS "evtOcrNo",
			a.EVT_PRGRS_CD AS "evtPrgrsCd",
			a.EVT_DTL AS "evtDtl",
			a.LONGITUDE::text as "lon",
			a.LATITUDE::text as "lat",
			b.VMS_START_CODE AS "vmsStartCd",
			b.VMS_END_CODE AS "vmsEndCd"
		FROM CM_EVT_OCR a
		JOIN CM_EVENT b ON a.EVT_ID = b.EVT_ID
		WHERE 1=1
		AND a.EVT_PRGRS_CD IN ('10', '30')
		AND TO_CHAR(now()-interval '1hour','YYYYMMDDHH24MISS') >= TO_CHAR(TO_TIMESTAMP(a.EVT_OCR_YMD_HMS,'YYYYMMDDHH24MISS'),'YYYYMMDDHH24MISS')
	</select>
	
	<update id="updateEventEnd" parameterType="map">
		UPDATE CM_EVT_OCR
		SET 
			EVT_END_YMD_HMS = TO_CHAR(TO_TIMESTAMP(EVT_OCR_YMD_HMS,'YYYYMMDDHH24MISS') + interval'1'HOUR,'YYYYMMDDHH24MISS'),
			EVT_PRGRS_CD = '91'
		WHERE 1=1
		AND EVT_OCR_NO = #{evtOcrNo}
	</update>
</mapper>
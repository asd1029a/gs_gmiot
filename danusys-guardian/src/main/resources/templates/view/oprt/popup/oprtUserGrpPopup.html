<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div class="cont_area">
	<div id="" class="cont_inner" title="">
		<ul class="popup-list-area">
			<li class="list">
				<div class="popup-list-title">
					<em>사용자그룹 아이디</em>
				</div>
				<div class="popup-list-cont">
					<input type="text" id="popupUserGrpId" placeholder="내용을 입력해 주세요."/>
				</div>
			</li>
			<li class="list">
				<div class="popup-list-title">
					<em>사용자그룹 명</em>
				</div>
				<div class="popup-list-cont">
					<input type="text" id="popupUserGrpNm" placeholder="내용을 입력해 주세요."/>
				</div>
			</li>
			<li class="list">
				<div class="popup-list-title">
					<em>사용자그룹 설명</em>
				</div>
				<div class="popup-list-cont">
					<input type="text" id="popupUserGrpRemark" placeholder="내용을 입력해 주세요."/>
				</div>
			</li>
			<li class="list">
				<div class="popup-list-title">
					<em>사용여부</em>
				</div>
				<div class="popup-list-cont">
					<select class="easyui-combobox" id="popupUserGrpUseTy">
						<option value="Y">사용</option>
						<option value="N">미사용</option>
					</select>
				</div>
			</li>
			<li class="list">
				<div class="popup-list-title">
					<em>사용자 추가</em>
				</div>
				<div class="popup-list-cont">
					<input type="text" id="popupUserNm" class="easyui-textbox wide80"
						placeholder="조직을 선택해 주세요." disabled/>
					<input type="hidden" id="popupUserId">
					<a href="#" class="single-btn" id="userPopBtn">선택</a>
				</div>
			</li>
			<!-- <li class="list2">
				<div class="popup-list-title2">
					<em>전파그룹 사용자 추가</em>
				</div>
				<div class="popup-list-cont2">
					<div class="left-area">
						<table id="oprtEventSendUserTable" title="" style="width:100%;height:300px;float:left;"></table>
					</div>
					<div class="middle-area">
						<button id="popupUserAddBtn" class="btn" onclick="addEventGroupUser()">추가</button>
						<button id="popupUserRemoveBtn" class="btn" onclick="removeEventGroupUser()">삭제</button>
					</div>
					<div class="right-area">
						<table id="oprtEventSendGrpTable" title="" style="width:100%;height:300px;float:left;"></table>
					</div>
				</div>
			</li> -->
		</ul>
		<ul class="center-btn">
			<li class="btn-cancle" onClick="closePopup();">취소</li>
			<li class="btn-insert" onClick="saveUserGroup();">저장</li>
		</ul>
	</div>
</div>

<script th:inline="javascript">
$(document).ready(function(){
	if (typeof(selectedData) != 'undefined' && selectedData != '') {
		setUserDetailData(selectedData);
	}
});

function setUserDetailData(data) {
	var row = data[0];
	$('#popupUserGrpId').attr('disabled', true);
	$('#popupUserGrpId').val(row.userGrpId);
	$('#popupUserGrpNm').val(row.userGrpNm);
	
	$('#popupUserGrpRemark').val(row.userGrpRemark);	
	$('#popupUserGrpUseTy').val(row.useYn);
	
	$('#popupUserId').val(row.userId);
	$('#popupUserNm').val(row.userNm);
}


function clearPopup() {
	$('#popupUserGrpId').val('');
	$('#popupUserGrpNm').val('');
	$('#popupUserGrpRemark').val('');
	$('#popupUserGrpUseTy').val('Y');
	$('#popupUserId').val('');
	$('#popupUserNm').val('');
	
}

function closePopup() {
	clearPopup();
	if (typeof(selectedData) != 'undefined' && selectedData != '') {
		selectedData='';
	}
	common.closeDialogPop("oprtUserGrpPopup");
}

function deleteSmsDetail() {
	var deleteRowId = [];
	deleteRowId.push($('#popupUserGrpId').val());
	
	const jsonObj = {};
	jsonObj.singleDeleteSid = "oprt.deleteSmsDetail";
	jsonObj.deleteRowId = deleteRowId;
	
    $.ajax({
            type       : "POST",
            url        : "/multiAjax/action.do",
            dataType   : "json",
            data : {"param" : JSON.stringify(jsonObj)},
            async      : false,
            beforeSend : function(xhr) {
                // 전송 전 Code
            }
        }).done(function (data) {
        	saveSmsGroupDetail();
    }).fail(function (xhr) {
        alert("등록 실패");
    }).always(function() {

    });
}

function saveUserGroup() {
	var groupId = $('#popupUserGrpId').val();
	var groupName = $('#popupUserGrpNm').val();
	var remark = $('#popupUserGrpRemark').val();
	var useYn = $('#popupUserGrpUseTy').val();
	var userId = $('#popupUserId').val();
	
	var groupIdCheck =(function(){
        const jsonObj = {};
        let rtnVal;
        jsonObj.groupId= $('#popupUserGrpId').val();
        $.ajax(
        {
            type       : "POST",
            url        : "/select/oprt.checkUserGrpChk/action.do",
            dataType   : "json",
            data       : {"param" : JSON.stringify(jsonObj)},
            async      : false,
            beforeSend : function(xhr) {
                // 전송 전 Code
            }
        }).done(function (result) {
    		const rows = result.rows;
        	if(rows=='sessionOut'){
    			alert('로그인 시간이 만료되었습니다.');
    			closeWindow();
    		}
            rtnVal = rows[0].idKey;
        }).fail(function (xhr) {

        }).always(function() {

        });
        return rtnVal;
    })();
	
	if(userId.length > 0) {
		var insertDatas = [];
		var userIdAry = userId.split(',');
		for(var i=0; i<userIdAry.length; i++) {
			insertDatas.push({'userId' : userIdAry[i], 'groupId': $('#popupUserGrpId').val()});
		}
	}
	
	if($('#popupUserId').val() == '') {
		alert('사용자를 1명 이상 등록해주십시오.');
		return false;
	}
	if(!checkNull(groupId, "사용자그룹 아이디를 입력해주십시오.")){
		return false;
	}
	if(!checkNull(groupName, "사용자그룹 이름을 입력해주십시오.")){
		return false;
	}
	
	if(!checkNull(remark, "사용자그룹 설명을 입력해주십시오.")){
		return false;
	}
	if(groupIdCheck > 0){
		alert("이미 사용중인 그룹아이디 입니다.");
		return false;
	}
	
	const jsonArray1 = [];
	const jsonArray2 = [];
	const jsonArray3 = [];
	const jsonArray4 = [];
	
	const jsonObj = {};
	const jsonObj1 = {};
	jsonObj.groupId = groupId;
	jsonObj.groupName = groupName;
	jsonObj.remark = remark;
	jsonObj.useYn = useYn;
	jsonObj.userId = insertDatas;
	jsonObj.rowStatus = 'C';
	
	jsonObj1.groupId = groupId;
	jsonObj1.rowStatus = 'D';
	
	jsonArray1[0] = jsonObj;
	jsonArray2[0] = jsonObj1;
    jsonArray3[0] = jsonObj;
	
	
	$.ajax({
		type       : "POST",
		url        : "/multiTransaction/oprt.saveUserGroup/oprt.deleteUserDetail/oprt.insertUserGroupDetail/{sqlid4}/action.do",
		dataType   : "json",
		data : {
			"param1" : JSON.stringify(jsonArray1),
            "param2" : JSON.stringify(jsonArray2),
            "param3" : JSON.stringify(jsonArray3),
            "param4" : JSON.stringify(jsonArray4)
			},
		async      : false,
		beforeSend : function(xhr) {
			// 전송 전 Code
		}
	}).done(function (result) {
		if (result == "SUCCESS") {
			//deleteSmsDetail();
			alert("저장 완료");
			closePopup();
			$('#oprtUserGroupTable').datagrid('reload');
		}
		else {
			alert("저장 실패");
		}
	}).fail(function (xhr) {
		alert("저장 실패");
	}).always(function() {
		
	});	
}


$("#userPopBtn").off("click").on(
	{
		"click": function ()
	{
		const path = "oprt/popup/oprtGroupTreePopup";
		console.log(path);
		common.openDialogPopPosition("oprtGroupTreePopup", "조직도", "300", "430", "true", "/action/page.do", {path: path}, path.split("/")[2],"callBackOprtUserGroupTreePopup");
	}
});


function callBackOprtUserGroupTreePopup(jsonObj)
{
    $("#popupUserNm").val(jsonObj.name);
    $("#popupUserId").val(jsonObj.id);
    common.closeDialogPop("oprtGroupTreePopup");
}
</script>